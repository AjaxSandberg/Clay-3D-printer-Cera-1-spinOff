[include mainsail.cfg]

# host MCU service is preinstalled and ready to use with:
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1C003D000851313339373836-if00

##################################################################################
# --- Allow programmatic control & safety ---
[force_move]
enable_force_move: true

# --- Guarded micro-move helper (useful for manual nudging) ---
[gcode_macro SAFE_GMOVE]
description: Guarded small-step move for live control
gcode:
  {% set dx = params.X|default(0.0)|float %}
  {% set dy = params.Y|default(0.0)|float %}
  {% set dz = params.Z|default(0.0)|float %}
  {% set f  = (params.F|default(4000)|float) | min(2000) %}
  {% if dx|abs > 2.0 or dy|abs > 2.0 or dz|abs > 1.0 %}
    RESPOND PREFIX="warn" MSG="Step too large; clamped."
  {% else %}
    G91
    G1 X{dx} Y{dy} Z{dz} F{f}
    G90
  {% endif %}

# --- Progress markers for the relay (chunk/window control) ---
[gcode_macro MARK]
description: Emits a websocket-visible progress marker for the relay
gcode:
  {% set k = params.K|default(0)|int %}
  RESPOND PREFIX="mark" MSG="{k}"

[gcode_macro LAYER]
description: Emits a websocket-visible layer change for UI/logging
gcode:
  {% set n = params.N|default(0)|int %}
  RESPOND PREFIX="layer" MSG="{n}"

############################################################################


[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 500
max_z_velocity: 15
max_z_accel: 25

#driver 0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
microsteps: 16
rotation_distance: 40
endstop_pin: PG6
position_min: 0
position_max: 280
homing_speed: 80
position_endstop: 280

[tmc2209 stepper_x]
uart_pin: PC4
run_current: 0.800
hold_current: 0.400
stealthchop_threshold: 999999


#driver 1 - y
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: PG9
position_min: 0
position_max: 240
homing_speed: 80
position_endstop: 240

[tmc2209 stepper_y]
uart_pin: PD11
run_current: 0.800
hold_current: 0.400
stealthchop_threshold: 999999

#driver 2 - 1 
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
microsteps: 16
rotation_distance: 8
endstop_pin: PG10
position_min: 0
position_max: 300
homing_speed: 10
position_endstop: 0

[tmc2209 stepper_z]
uart_pin: PC6
run_current: 0.800
hold_current: 0.400
stealthchop_threshold: 999999

[extruder]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 16
rotation_distance: 17.8
gear_ratio: 5.18:1
nozzle_diameter: 0.8
filament_diameter: 1.750
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp:-273.15
max_temp: 9999999999
min_extrude_temp: -273.15

[tmc2209 extruder]
uart_pin: PF2
run_current: 0.800
hold_current: 0.400

[extruder_stepper extruder1]
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
microsteps: 16
# derived by taking extrusion distance times extrusion to push ratio depending on nozzle dia
rotation_distance: 70
gear_ratio: 30:1
extruder: extruder
